<#-- 试卷下添加题目 -->
<#include "ftl/comm.ftl"/>
<#assign module="papers_paper_add"/>
<#assign dg="${module}_list_dg"/>
<script type="text/javascript">
<!--
$(function(){
	var current_structure_id = "", current_item_type = "", current_item_type_name = "";
	//clear structure add value.
	function clean_paper_add_value(){
		current_structure_id = current_item_type = current_item_type_name = "";
		if(dg){
			$("#${dg}_toobar_add").linkbutton("disable");
		}
	}
	//set structure add value.
	function set_paper_add_value(structure_id,item_type,item_type_name){
		current_structure_id = structure_id;
		current_item_type = item_type;
		current_item_type_name = item_type_name;
		if(dg){
			if(!current_item_type || $.trim(current_item_type) == "")
				$("#${dg}_toobar_add").linkbutton("disable");
			else
				$("#${dg}_toobar_add").linkbutton("enable");
		}
	}
	//paper structure tree
	var paper_structure_tree = $("#${module}_structures_tree").tree({
		url:"<@s.url '/admin/papers/paper/structures/tree/'/>${CURRENT_PAPER_ID}",
		onLoadError:function(e){
			<@error_dialog "e"/>
		},
		onBeforeLoad:function(){
			clean_paper_add_value();
		},
		onContextMenu:function(e,node){
			e.preventDefault();
			
			set_paper_add_value(node.id,node.attributes.type,node.attributes.typeName);
			
			paper_structure_tree.tree("select",node.target);
			
			$("#${module}_structures_tree_mm").menu("show",{
				left: e.pageX,
				top: e.pageY
			});
		},
		onClick:function(node){
			set_paper_add_value(node.id,node.attributes.type,node.attributes.typeName);
			${dg}_search();
		},
		onDblClick:function(node){
			if(node && node.attributes){
				set_paper_add_value(node.id,node.attributes.type,node.attributes.typeName);
				
				structrue_edit_window("编辑试卷结构",current_structure_id,node.attributes)
			}
		}
	});
	//paper structrue window
	function structrue_edit_window(title,structureId,row){
		var d = $("<div/>").dialog({
			title:title,
			width:400,
			height:300,
			href:"<@s.url '/admin/papers/paper/structures/${CURRENT_PAPER_ID}/edit'/>?structureId=" + structureId,
			modal:true,
			buttons:[
			   <@shiro.hasPermission name="${PER_UPDATE}">
			   {
				text:"保存",
				iconCls:"icon-save",
				handler:function(){
					$.messager.progress();
					$("#${module}_structure_edit_form").form("submit",{
						url:"<@s.url '/admin/papers/paper/structures/${CURRENT_PAPER_ID}/update'/>",
						onSubmit: function(){
							var isValid = $(this).form("validate");
							if (!isValid)$.messager.progress("close");
							return isValid;
						},
						onLoadError:function(e){
							$.messager.progress("close");
							<@error_dialog "e"/>
						},
						success:function(data){
							$.messager.progress("close");
							var data = $.parseJSON(data);
							if(data.success){
								paper_structure_tree.tree("reload");
								d.dialog("close");
							}else{
								$.messager.show({
									title:"保存异常",
									msg:data.msg
								});
							}
						}
					});
				}
			},
			</@shiro.hasPermission>
			{
				text:"关闭",
				iconCls:"icon-cancel",
				handler:function(){
					d.dialog("close");
				}
			}],
			onClose:function(){
				$(this).dialog("destroy");
			},
			onLoad:function(){
				if(row) $("#${module}_structure_edit_form").form("load",row);
			}
	  });
	}
	//add paper structure.
	${module}_structures_add = function(top){
		structrue_edit_window("新增试卷结构","",  top ? null :  {pid:current_structure_id});
	};
	<@shiro.hasPermission name="${PER_DELETE}">
	//remove paper structure.
	${module}_structures_remove = function(){
		var node = paper_structure_tree.tree("getSelected");
		if(!node || $.trim(node.id) == ""){
			$.messager.alert("提示","未选中须删除的试卷结构节点！");
			return;
		}
		$.messager.confirm("确认","您是否确认删除选中的数据?",function(r){
			if(!r)return;
			$.messager.progress();
				$.ajax({
					url:"<@s.url '/admin/papers/paper/structures/delete'/>",
					type:"POST",
					data:{structureId:node.id},
					dataType:"json",
					error:function(e){
						$.messager.progress("close");
						<@error_dialog "e"/>
					},
					success:function(data,textStatus){
						$.messager.progress("close");
						if(data.success){
							paper_structure_tree.tree("reload");
							dg.datagrid("load");
							dg.datagrid("unselectAll");
						}else{
							$.messager.show({
								title:"提示",
								msg:data.msg
							});
						}
					}
				});
			});
		};
		</@shiro.hasPermission>
		//dg
		var dg=$("#${dg}").datagrid({
			url:"<@s.url '/admin/papers/paper/structures/items/${CURRENT_PAPER_ID}/datagrid'/>",
			fit:true,
			fitColumns:true,
			rownumbers:true,
			pagination:true,
			pagePosition:"bottom",
			pageSize:20,
			pageList:[20,30,40],
			border:true,
			striped:true,
			idField:"id",
			sortName:"orderNo",
			sortOrder:"asc",
			columns:[[{
				field:"id",
				checkbox:true
			},{
				title:"题号",
				field:"serial",
				width:8,
				align:"left",
				sortable:true
			},{
				title:"题型",
				field:"typeName",
				width:15,
				align:"center",
				sortable:true
			},{
				title:"题目",
				field:"item.content",
				width:60,
				align:"left",
				formatter: function(value,row,index){
					return row.item.content;
				},
				sortable:true
			},{
				title:"分数",
				field:"score",
				width:10,
				align:"right",
				sortable:true
			}]],
			onLoadError:function(e){
				<@error_dialog "e"/>
			},
			toolbar:"#${dg}_toobar",
			onDblClickRow:function(rowIndex,rowData){
				structrue_item_edit_window("编辑试卷题目",rowIndex,rowData);
			}
		});
		//search
		${dg}_search = function(){
			dg.datagrid("load",{
				"structureId":current_structure_id,
				"item.content":$("#${dg}_toobar input[name='content']").val()
			});
		};
		//add item.
		${dg}_add = function(){
			if(!current_item_type || $.trim(current_item_type) == ""){
				$.messager.alert("提示","请选中左边试卷结构！");
				return;
			}
			structrue_item_edit_window("新增试卷题目",0,null);
		};
		//structrue item edit.
		function structrue_item_edit_window(title,index,row){
			var type = current_item_type,typeName = current_item_type_name,structureId = current_structure_id;
			if(row){
				type = row.type;
				typeName = row.typeName;
				structureId = row.structureId;
			}
			var d = $("<div/>").dialog({
				title:title + "["+typeName+"]",
				width:800,
				height:600,
				href:"<@s.url '/admin/papers/paper/structures/items/'/>" + type +"/edit/" + structureId + "?paperId=${CURRENT_PAPER_ID}",
				modal:true,
				buttons:[
				   <@shiro.hasPermission name="${PER_UPDATE}">      
				   {
					text:"保存",
					iconCls:"icon-save",
					handler:function(){
						$.messager.progress();
						var isValid = eval("${module}_structure_item_"+type+"_validate()");
						if (!isValid){
							$.messager.progress("close");
							return;
						}
						var post = eval("${module}_structure_item_"+type+"_update()");
						if(!post){
							$.messager.progress("close");
							$.messager.alert("提示","获取试卷题目数据失败！");
							return;
						}
						$.ajax({
							url:"<@s.url '/admin/papers/paper/structures/items/${CURRENT_PAPER_ID}/update'/>",
							type:"POST",
							data:JSON.stringify(post),
							dataType:"json",
							contentType:"application/json;charset=UTF-8",
							error:function(e){
								$.messager.progress("close");
								<@error_dialog "e"/>
							},
							success:function(data,textStatus){
								$.messager.progress("close");
								if(data.success){
									dg.datagrid("load");
									dg.datagrid("unselectAll");
								}else{
									$.messager.show({
										title:"提示",
										msg:data.msg
									});
								}
								d.dialog("close");
							}
						});
					}
				},
				</@shiro.hasPermission>
				{
					text:"关闭",
					iconCls:"icon-cancel",
					handler:function(){
						d.dialog("close");
					}
				}],
				onClose:function(){
					$(this).dialog("destroy");
				},
				onLoad:function(){
					if(row && row.id){
						$.getJSON("<@s.url '/admin/papers/paper/item/'/>" + row.id,function(data){
							if(data.type != type){
								$.messager.alert("提示","当前试卷题目题型["+data.typeName+"]与当前题目编辑页面题型不符！");
								return;
							}
							eval("${module}_structure_item_"+type +"_load(data)");
						});
					}else{
						eval("${module}_structure_item_"+type+"_last_load()");
					}
				}
		  });
		};
		<@shiro.hasPermission name="${PER_DELETE}">
		//delete item.
		${dg}_delete = function(){
			var rows = dg.datagrid("getChecked");
			if(rows && rows.length > 0){
				$.messager.confirm("确认","您是否确认删除选中的题目数据?",function(r){
					if(!r)return;
					$.messager.progress();
					var ids = [];
					for(var i = 0; i < rows.length; i++){
						ids.push(rows[i].id);
					}
					$.ajax({
						url:"<@s.url '/admin/papers/paper/structures/items/delete'/>",
						type:"POST",
						data:{
							id:ids.join("|")
						},
						dataType:"json",
						error:function(e){
							$.messager.progress("close");
							<@error_dialog "e"/>
						},
						success:function(data,textStatus){
							$.messager.progress("close");
							if(data.success){
								dg.datagrid("load");
								dg.datagrid("unselectAll");
							}else{
								$.messager.show({
									title:"提示",
									msg:data.msg
								});
							}
						}
					});
				});
			}else{
				$.messager.alert("提示","未选中须删除的数据！");
			}
		};
		</@shiro.hasPermission>
});
//-->
</script>
<div class="easyui-layout" data-options="fit:true">
	<div data-options="region:'west',title:'试卷结构',split:true,tools:[
		{
			iconCls:'icon-add',
		 	handler:function(){
		 		${module}_structures_add(true);
		 	}
		},{
			iconCls:'icon-reload',
		 	handler:function(){
		 		$('#${module}_structures_tree').tree('reload');
		 		${dg}_search();
		 	}
	 }]" style="padding:5px;width:200px;">
	 	 <ul id="${module}_structures_tree"></ul>
	 	 <div id="${module}_structures_tree_mm" class="easyui-menu" style="width:120px;">
	 	 	<@shiro.hasPermission name="${PER_UPDATE}">
	 	 	<div onclick="${module}_structures_add(false)" data-options="iconCls:'icon-add'">添加试卷结构</div>
	 	 	</@shiro.hasPermission>
	 	 	<@shiro.hasPermission name="${PER_DELETE}">
	 	 	<div onclick="${module}_structures_remove()" data-options="iconCls:'icon-remove'">删除试卷结构</div>
	 	 	</@shiro.hasPermission>
	 	 </div>
	 </div>
	 <div data-options="region:'center',title:'题目列表'">
	 		<table id="${dg}"></table>
	 		<div id="${dg}_toobar">
	 			<@shiro.hasPermission name="${PER_UPDATE}">
				<a id="${dg}_toobar_add" href="#" class="easyui-linkbutton" onclick="${dg}_add()" data-options="iconCls:'icon-add',plain:true,disabled:true" style="float:left;">添加</a>
				</@shiro.hasPermission>
				<span>|</span>
				<@shiro.hasPermission name="${PER_DELETE}">
				<a href="#" class="easyui-linkbutton" onclick="${dg}_delete()" data-options="iconCls:'icon-remove',plain:true">删除</a>
				</@shiro.hasPermission>
				<label>题目：<input name="content" type="text" style="width:168px;"/></label>
				
				<a href="#" class="easyui-linkbutton" style="margin-left:10px;"  onclick="${dg}_search()" data-options="iconCls:'icon-search',plain:true">查询</a>
			</div>
	 </div>
</div>